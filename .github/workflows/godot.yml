name: Godot Extension Build

on:
  push:
    paths:
      - 'platforms/godot/**'
    branches:
      - main
  pull_request:
    paths:
      - 'platforms/godot/**'
  workflow_dispatch:

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.version-check.outputs.changed || 'true' }}
      version: ${{ steps.version-check.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check version changes
        uses: EndBug/version-check@v2
        id: version-check
        continue-on-error: true
        with:
          file-name: platforms/godot/addons/colyseus/version.json
          diff-search: ${{ github.event_name == 'push' }}

      - name: Log version info
        run: |
          echo "Version changed: ${{ steps.version-check.outputs.changed }}"
          echo "Version: ${{ steps.version-check.outputs.version }}"

  build-macos:
    needs: check-version
    if: needs.check-version.outputs.changed == 'true'
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build macOS arm64 (debug)
        working-directory: platforms/godot
        run: zig build -Dtarget=aarch64-macos -Doptimize=Debug

      - name: Build macOS arm64 (release)
        working-directory: platforms/godot
        run: zig build -Dtarget=aarch64-macos -Doptimize=ReleaseSafe

      - name: Upload macOS binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-macos
          path: platforms/godot/addons/colyseus/bin/*.dylib

  build-ios:
    needs: check-version
    if: needs.check-version.outputs.changed == 'true'
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Get iOS SDK path
        id: ios-sdk
        run: echo "path=$(xcrun --sdk iphoneos --show-sdk-path)" >> $GITHUB_OUTPUT

      - name: Populate Zig cache (fetch dependencies)
        working-directory: platforms/godot
        run: |
          zig build --fetch
          echo "=== .zig-cache/p ==="
          find .zig-cache/p -name "msgpack.zig" 2>/dev/null || echo "not found"
          echo "=== ZIG_GLOBAL_CACHE_DIR ==="
          echo "ZIG_GLOBAL_CACHE_DIR=$ZIG_GLOBAL_CACHE_DIR"
          find "$ZIG_GLOBAL_CACHE_DIR/p" -name "msgpack.zig" 2>/dev/null || echo "not found"

      - name: Build iOS arm64 (debug)
        working-directory: platforms/godot
        run: |
          SDK="${{ steps.ios-sdk.outputs.path }}"
          OUT="addons/colyseus/bin"
          mkdir -p "$OUT"

          MSGPACK_ZIG=$(find "$ZIG_GLOBAL_CACHE_DIR/p" -name "msgpack.zig" 2>/dev/null | grep zig_msgpack | head -1)
          echo "Found msgpack.zig at: $MSGPACK_ZIG"
            if [ -z "$MSGPACK_ZIG" ]; then
          echo "ERROR: msgpack.zig not found"
            exit 1
            fi

          INCLUDES=(
            -I../../include
            -I../../src
            -I../../third_party/uthash/src
            -I../../third_party/sds
            -I../../third_party/cJSON
            -I../../third_party/wslay/lib/includes
            -I../../third_party/wslay/lib
            -Iinclude
            -Isrc
          )

          C_SOURCES=(
            src/register_types.c
            src/colyseus_client.c
            src/colyseus_room.c
            src/colyseus_callbacks.c
            src/colyseus_state.c
            src/colyseus_schema_registry.c
            src/colyseus_gdscript_schema.c
            src/msgpack_variant.c
            src/msgpack_encoder.c
            ../../src/common/settings.c
            ../../src/client.c
            ../../src/room.c
            ../../src/network/websocket_transport.c
            ../../src/schema/decode.c
            ../../src/schema/ref_tracker.c
            ../../src/schema/collections.c
            ../../src/schema/decoder.c
            ../../src/schema/serializer.c
            ../../src/schema/callbacks.c
            ../../src/schema/dynamic_schema.c
            ../../src/utils/strUtil.c
            ../../src/utils/sha1_c.c
            ../../src/auth/auth.c
            ../../src/auth/secure_storage.c
            ../../third_party/sds/sds.c
            ../../third_party/cJSON/cJSON.c
            ../../third_party/wslay/lib/wslay_event.c
            ../../third_party/wslay/lib/wslay_frame.c
            ../../third_party/wslay/lib/wslay_net.c
            ../../third_party/wslay/lib/wslay_queue.c
          )

          # Generate wslay config headers
          mkdir -p .zig-cache/config/wslay
          cat > .zig-cache/config/config.h << 'EOF'
          #define HAVE_ARPA_INET_H 1
          #define HAVE_NETINET_IN_H 1
          EOF
          cp ../../third_party/wslay/lib/includes/wslay/wslayver.h.in .zig-cache/config/wslay/wslayver.h
          sed -i '' 's/@PACKAGE_VERSION@/1.1.1/g' .zig-cache/config/wslay/wslayver.h

          INCLUDES+=(-I.zig-cache/config)

          # Compile Zig sources to object files
          zig build-obj \
            -target aarch64-ios \
            -ODebug \
            --sysroot "$SDK" \
            --dep msgpack \
            -Mroot=src/msgpack_godot.zig \
            --dep msgpack \
            -Mmsgpack="$MSGPACK_ZIG" \
            "${INCLUDES[@]}" \
            -femit-bin=.zig-cache/msgpack_godot.o

          zig build-obj \
            -target aarch64-ios \
            -ODebug \
            --sysroot "$SDK" \
            -Mroot=../../src/network/http.zig \
            "${INCLUDES[@]}" \
            -femit-bin=.zig-cache/http_zig.o

          zig build-obj \
            -target aarch64-ios \
            -ODebug \
            --sysroot "$SDK" \
            -Mroot=../../src/utils/strUtil.zig \
            "${INCLUDES[@]}" \
            -femit-bin=.zig-cache/strutil_zig.o

          zig build-obj \
            -target aarch64-ios \
            -ODebug \
            --sysroot "$SDK" \
            --dep msgpack \
            -Mroot=../../src/msgpack/msgpack_builder.zig \
            --dep msgpack \
            -Mmsgpack="$MSGPACK_ZIG" \
            "${INCLUDES[@]}" \
            -femit-bin=.zig-cache/msgpack_builder.o

          # Link everything with clang
          xcrun clang \
            -target arm64-apple-ios13.0 \
            -isysroot "$SDK" \
            -dynamiclib \
            -install_name "@rpath/libcolyseus_godot.ios.arm64.debug.framework/libcolyseus_godot.ios.arm64.debug" \
            -o "$OUT/libcolyseus_godot.ios.arm64.debug.dylib" \
            "${INCLUDES[@]}" \
            -Wall -Wextra -Wno-unused-parameter \
            -DHAVE_CONFIG_H \
            "${C_SOURCES[@]}" \
            .zig-cache/msgpack_godot.o \
            .zig-cache/http_zig.o \
            .zig-cache/strutil_zig.o \
            .zig-cache/msgpack_builder.o \
            -framework CoreFoundation \
            -framework Security \
            -lc

      - name: Build iOS arm64 (release)
        working-directory: platforms/godot
        run: |
          SDK="${{ steps.ios-sdk.outputs.path }}"
          OUT="addons/colyseus/bin"

          MSGPACK_ZIG=$(find "$ZIG_GLOBAL_CACHE_DIR/p" -name "msgpack.zig" 2>/dev/null | grep zig_msgpack | head -1)
          echo "Found msgpack.zig at: $MSGPACK_ZIG"
            if [ -z "$MSGPACK_ZIG" ]; then
          echo "ERROR: msgpack.zig not found"
            exit 1
            fi

          INCLUDES=(
            -I../../include
            -I../../src
            -I../../third_party/uthash/src
            -I../../third_party/sds
            -I../../third_party/cJSON
            -I../../third_party/wslay/lib/includes
            -I../../third_party/wslay/lib
            -Iinclude
            -Isrc
            -I.zig-cache/config
          )

          C_SOURCES=(
            src/register_types.c
            src/colyseus_client.c
            src/colyseus_room.c
            src/colyseus_callbacks.c
            src/colyseus_state.c
            src/colyseus_schema_registry.c
            src/colyseus_gdscript_schema.c
            src/msgpack_variant.c
            src/msgpack_encoder.c
            ../../src/common/settings.c
            ../../src/client.c
            ../../src/room.c
            ../../src/network/websocket_transport.c
            ../../src/schema/decode.c
            ../../src/schema/ref_tracker.c
            ../../src/schema/collections.c
            ../../src/schema/decoder.c
            ../../src/schema/serializer.c
            ../../src/schema/callbacks.c
            ../../src/schema/dynamic_schema.c
            ../../src/utils/strUtil.c
            ../../src/utils/sha1_c.c
            ../../src/auth/auth.c
            ../../src/auth/secure_storage.c
            ../../third_party/sds/sds.c
            ../../third_party/cJSON/cJSON.c
            ../../third_party/wslay/lib/wslay_event.c
            ../../third_party/wslay/lib/wslay_frame.c
            ../../third_party/wslay/lib/wslay_net.c
            ../../third_party/wslay/lib/wslay_queue.c
          )

          zig build-obj \
            -target aarch64-ios \
            -OReleaseSafe \
            --sysroot "$SDK" \
            --dep msgpack \
            -Mroot=src/msgpack_godot.zig \
            --dep msgpack \
            -Mmsgpack="$MSGPACK_ZIG" \
            "${INCLUDES[@]}" \
            -femit-bin=.zig-cache/msgpack_godot_rel.o

          zig build-obj \
            -target aarch64-ios \
            -OReleaseSafe \
            --sysroot "$SDK" \
            -Mroot=../../src/network/http.zig \
            "${INCLUDES[@]}" \
            -femit-bin=.zig-cache/http_zig_rel.o

          zig build-obj \
            -target aarch64-ios \
            -OReleaseSafe \
            --sysroot "$SDK" \
            -Mroot=../../src/utils/strUtil.zig \
            "${INCLUDES[@]}" \
            -femit-bin=.zig-cache/strutil_zig_rel.o

          zig build-obj \
            -target aarch64-ios \
            -OReleaseSafe \
            --sysroot "$SDK" \
            --dep msgpack \
            -Mroot=../../src/msgpack/msgpack_builder.zig \
            --dep msgpack \
            -Mmsgpack="$MSGPACK_ZIG" \
            "${INCLUDES[@]}" \
            -femit-bin=.zig-cache/msgpack_builder_rel.o

          xcrun clang \
            -target arm64-apple-ios13.0 \
            -isysroot "$SDK" \
            -dynamiclib \
            -O2 \
            -install_name "@rpath/libcolyseus_godot.ios.arm64.release.framework/libcolyseus_godot.ios.arm64.release" \
            -o "$OUT/libcolyseus_godot.ios.arm64.release.dylib" \
            "${INCLUDES[@]}" \
            -Wall -Wextra -Wno-unused-parameter \
            -DHAVE_CONFIG_H \
            "${C_SOURCES[@]}" \
            .zig-cache/msgpack_godot_rel.o \
            .zig-cache/http_zig_rel.o \
            .zig-cache/strutil_zig_rel.o \
            .zig-cache/msgpack_builder_rel.o \
            -framework CoreFoundation \
            -framework Security \
            -lc

      - name: Upload iOS binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-ios
          path: platforms/godot/addons/colyseus/bin/*ios*.dylib

  build-linux:
    needs: check-version
    if: needs.check-version.outputs.changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build Linux x86_64 (debug)
        working-directory: platforms/godot
        run: zig build -Dtarget=x86_64-linux-gnu -Doptimize=Debug

      - name: Build Linux x86_64 (release)
        working-directory: platforms/godot
        run: zig build -Dtarget=x86_64-linux-gnu -Doptimize=ReleaseSafe

      - name: Upload Linux binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-linux
          path: platforms/godot/addons/colyseus/bin/*.so

  build-windows:
    needs: check-version
    if: needs.check-version.outputs.changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build Windows x86_64 (debug)
        working-directory: platforms/godot
        run: zig build -Dtarget=x86_64-windows-gnu -Doptimize=Debug

      - name: Build Windows x86_64 (release)
        working-directory: platforms/godot
        run: zig build -Dtarget=x86_64-windows-gnu -Doptimize=ReleaseSafe

      - name: Build Windows x86_32 (debug)
        working-directory: platforms/godot
        run: zig build -Dtarget=x86-windows-gnu -Doptimize=Debug

      - name: Build Windows x86_32 (release)
        working-directory: platforms/godot
        run: zig build -Dtarget=x86-windows-gnu -Doptimize=ReleaseSafe

      - name: Upload Windows binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-windows
          path: platforms/godot/addons/colyseus/bin/*.dll

  build-android:
    needs: check-version
    if: needs.check-version.outputs.changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26d

      - name: Build Android arm64 (debug)
        working-directory: platforms/godot
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: zig build -Dtarget=aarch64-linux-android -Doptimize=Debug

      - name: Build Android arm64 (release)
        working-directory: platforms/godot
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: zig build -Dtarget=aarch64-linux-android -Doptimize=ReleaseSafe

      - name: Build Android arm32 (debug)
        working-directory: platforms/godot
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: zig build -Dtarget=arm-linux-androideabi -Doptimize=Debug

      - name: Build Android arm32 (release)
        working-directory: platforms/godot
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: zig build -Dtarget=arm-linux-androideabi -Doptimize=ReleaseSafe

      - name: Build Android x86_64 (debug)
        working-directory: platforms/godot
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: zig build -Dtarget=x86_64-linux-android -Doptimize=Debug

      - name: Build Android x86_64 (release)
        working-directory: platforms/godot
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: zig build -Dtarget=x86_64-linux-android -Doptimize=ReleaseSafe

      - name: Upload Android binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-android
          path: platforms/godot/addons/colyseus/bin/*android*.so

  release:
    needs: [check-version, build-macos, build-ios, build-linux, build-windows, build-android]
    if: needs.check-version.outputs.changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create bin directory
        run: mkdir -p platforms/godot/addons/colyseus/bin

      - name: Download macOS binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-macos
          path: platforms/godot/addons/colyseus/bin

      - name: Download iOS binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-ios
          path: platforms/godot/addons/colyseus/bin

      - name: Download Linux binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-linux
          path: platforms/godot/addons/colyseus/bin

      - name: Download Windows binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-windows
          path: platforms/godot/addons/colyseus/bin

      - name: Download Android binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-android
          path: platforms/godot/addons/colyseus/bin

      - name: List all binaries
        run: ls -la platforms/godot/addons/colyseus/bin/

      - name: Create release zip
        working-directory: platforms/godot
        run: zip -r colyseus-godot-${{ needs.check-version.outputs.version }}.zip addons

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: godot-v${{ needs.check-version.outputs.version }}
          name: Godot SDK v${{ needs.check-version.outputs.version }}
          body: |
            ## Colyseus Godot SDK v${{ needs.check-version.outputs.version }}

            ### Installation
            1. Download the `colyseus-godot-${{ needs.check-version.outputs.version }}.zip` file
            2. Extract the `addons` folder into your Godot project root
            3. Enable the plugin in Project Settings > Plugins

            ### Supported Platforms
            - Web
            - macOS (arm64)
            - iOS (arm64)
            - Windows (x86_32, x86_64)
            - Linux (x86_64)
            - Android (arm32, arm64, x86_64)
          files: platforms/godot/colyseus-godot-${{ needs.check-version.outputs.version }}.zip
          draft: false
          prerelease: ${{ contains(needs.check-version.outputs.version, 'alpha') || contains(needs.check-version.outputs.version, 'beta') || contains(needs.check-version.outputs.version, 'rc') }}